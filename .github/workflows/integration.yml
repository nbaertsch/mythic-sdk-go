name: Integration Tests

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  integration-test:
    name: E2E Tests - ${{ matrix.test-group }}
    runs-on: ubuntu-latest
    timeout-minutes: 20

    strategy:
      fail-fast: false
      matrix:
        test-group:
          - "Phase 1+2: Core APIs"
          - "Phase 3: Agent Tests"
        include:
          - test-group: "Phase 1+2: Core APIs"
            test-pattern: "TestE2E_Auth|TestE2E_Operations|TestE2E_File|TestE2E_Credential|TestE2E_Artifact|TestE2E_Tag|TestE2E_Operator|TestE2E_C2Profile|TestE2E_MITREAttack|TestE2E_Payload"
            skip-agent: "true"
          - test-group: "Phase 3: Agent Tests"
            test-pattern: "TestE2E_Callback"
            skip-agent: "false"

    steps:
      - name: Checkout SDK
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Verify Test Compilation
        run: |
          echo "::group::Compiling integration tests"
          if ! go test -c -tags=integration ./tests/integration/... -o /tmp/integration.test; then
            echo "::error::‚ùå Integration tests failed to compile"
            exit 1
          fi
          echo "‚úÖ Integration tests compiled successfully"
          echo "::endgroup::"

      - name: Clone Mythic Framework
        run: |
          echo "::group::Cloning Mythic"
          git clone --depth 1 https://github.com/its-a-feature/Mythic.git /tmp/mythic
          cd /tmp/mythic
          echo "Mythic version: $(cat VERSION)"
          echo "::endgroup::"

      - name: Build Mythic CLI
        run: |
          echo "::group::Building Mythic CLI"
          cd /tmp/mythic
          sudo make
          sudo chmod +x mythic-cli
          echo "::endgroup::"

      - name: Configure Mythic
        run: |
          echo "::group::Configuring Mythic"
          cd /tmp/mythic
          sudo ./mythic-cli config set jupyter_bind_localhost_only false || true
          echo "::endgroup::"

      - name: Start Mythic
        run: |
          echo "::group::Starting Mythic services"
          cd /tmp/mythic
          sudo ./mythic-cli start
          echo "::endgroup::"

      - name: Wait for Mythic Ready
        run: |
          echo "::group::Waiting for Mythic to be ready"
          timeout=180
          attempt=0
          while [ $attempt -lt $timeout ]; do
            if curl -k -s https://127.0.0.1:7443 > /dev/null 2>&1; then
              echo "‚úÖ Mythic is ready after $attempt seconds"
              break
            fi
            sleep 5
            attempt=$((attempt + 5))
          done

          if [ $attempt -ge $timeout ]; then
            echo "::error::‚ùå Mythic failed to start within timeout"
            cd /tmp/mythic
            sudo ./mythic-cli status
            exit 1
          fi
          echo "::endgroup::"

      - name: Extract Mythic Credentials
        id: mythic-creds
        run: |
          PASSWORD=$(grep MYTHIC_ADMIN_PASSWORD /tmp/mythic/.env | cut -d'=' -f2 | tr -d '"')
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Run Integration Tests - ${{ matrix.test-group }}
        env:
          MYTHIC_URL: "https://127.0.0.1:7443"
          MYTHIC_USERNAME: "mythic_admin"
          MYTHIC_PASSWORD: ${{ steps.mythic-creds.outputs.password }}
          MYTHIC_SKIP_TLS_VERIFY: "true"
          SKIP_AGENT_TESTS: ${{ matrix.skip-agent }}
        run: |
          echo "::group::Running ${{ matrix.test-group }}"
          echo "Test Pattern: ${{ matrix.test-pattern }}"
          echo "Skip Agent Tests: ${{ matrix.skip-agent }}"

          # Run tests and capture exit code
          set +e
          TEST_LOG_FILE="integration-test-output-$(echo '${{ matrix.test-group }}' | tr ' :+' '_').log"
          go test -v -tags=integration ./tests/integration/... \
            -run "${{ matrix.test-pattern }}" \
            -timeout 10m \
            2>&1 | tee "$TEST_LOG_FILE"

          TEST_EXIT_CODE=$?
          set -e

          echo "::endgroup::"

          # Parse test results
          echo "::group::Test Results Summary"
          PASSED=$(grep -c "^=== RUN" "$TEST_LOG_FILE" || echo "0")
          FAILED=$(grep -c "^--- FAIL:" "$TEST_LOG_FILE" || echo "0")
          SKIPPED=$(grep -c "^--- SKIP:" "$TEST_LOG_FILE" || echo "0")

          echo "üìä Test Results for ${{ matrix.test-group }}:"
          echo "   Tests Run: $PASSED"
          echo "   Failed: $FAILED"
          echo "   Skipped: $SKIPPED"

          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "::error::‚ùå Tests failed with exit code $TEST_EXIT_CODE"
            echo "::endgroup::"
            exit $TEST_EXIT_CODE
          fi

          if [ $FAILED -gt 0 ]; then
            echo "::error::‚ùå $FAILED test(s) failed"
            echo "::endgroup::"
            exit 1
          fi

          echo "‚úÖ All tests passed!"
          echo "::endgroup::"

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results-$(echo '${{ matrix.test-group }}' | tr ' :+' '_')
          path: integration-test-output-*.log
          retention-days: 7

      - name: Collect Mythic Logs on Failure
        if: failure()
        run: |
          echo "::group::Collecting Mythic logs"
          cd /tmp/mythic
          sudo ./mythic-cli logs > mythic-logs.txt 2>&1 || true
          sudo docker ps -a > docker-containers.txt || true
          sudo ./mythic-cli status || true
          echo "::endgroup::"

      - name: Upload Mythic Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mythic-failure-logs-$(echo '${{ matrix.test-group }}' | tr ' :+' '_')
          path: |
            /tmp/mythic/mythic-logs.txt
            /tmp/mythic/docker-containers.txt
          retention-days: 7

      - name: Cleanup Mythic
        if: always()
        run: |
          echo "::group::Cleaning up Mythic"
          cd /tmp/mythic
          sudo ./mythic-cli stop || true
          sudo docker system prune -af || true
          echo "::endgroup::"

  # Summary job that requires all matrix jobs to pass
  integration-test-summary:
    name: Integration Tests - Summary
    runs-on: ubuntu-latest
    needs: integration-test
    if: always()

    steps:
      - name: Check Integration Test Results
        run: |
          echo "::group::Integration Test Summary"
          if [ "${{ needs.integration-test.result }}" != "success" ]; then
            echo "::error::‚ùå Some integration tests failed or were cancelled"
            echo "Check the individual test group results above for details"
            exit 1
          fi
          echo "‚úÖ All integration test groups passed!"
          echo "::endgroup::"
