name: Integration Tests

on:
  push:
    branches: [main, develop]
    tags: ['v*']
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  integration-test:
    name: Integration Tests with Mythic
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout SDK
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Clone Mythic Framework
        run: |
          git clone --depth 1 https://github.com/its-a-feature/Mythic.git /tmp/mythic
          cd /tmp/mythic
          echo "Mythic version: $(cat VERSION)"

      - name: Build Mythic CLI
        run: |
          cd /tmp/mythic
          sudo make
          sudo chmod +x mythic-cli

      - name: Configure Mythic
        run: |
          cd /tmp/mythic
          # Disable jupyter to avoid startup issues
          sudo ./mythic-cli config set jupyter_bind_localhost_only false || true

      - name: Start Mythic
        run: |
          cd /tmp/mythic
          sudo ./mythic-cli start

      - name: Wait for Mythic Ready
        run: |
          echo "Waiting for Mythic to be ready..."
          timeout=180
          attempt=0
          while [ $attempt -lt $timeout ]; do
            if curl -k -s https://127.0.0.1:7443 > /dev/null 2>&1; then
              echo "✓ Mythic is ready after $attempt seconds"
              break
            fi
            sleep 5
            attempt=$((attempt + 5))
          done

          if [ $attempt -ge $timeout ]; then
            echo "✗ Mythic failed to start within timeout"
            cd /tmp/mythic
            sudo ./mythic-cli status
            exit 1
          fi

      - name: Extract Mythic Credentials
        id: mythic-creds
        run: |
          PASSWORD=$(grep MYTHIC_ADMIN_PASSWORD /tmp/mythic/.env | cut -d'=' -f2 | tr -d '"')
          echo "::add-mask::$PASSWORD"
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT

      - name: Run Integration Tests
        env:
          MYTHIC_URL: "https://127.0.0.1:7443"
          MYTHIC_USERNAME: "mythic_admin"
          MYTHIC_PASSWORD: ${{ steps.mythic-creds.outputs.password }}
          MYTHIC_SKIP_TLS_VERIFY: "true"
        run: |
          go test -v -tags=integration ./tests/integration/... \
            -timeout 10m \
            2>&1 | tee integration-test-output.log

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: integration-test-output.log
          retention-days: 7

      - name: Collect Mythic Logs on Failure
        if: failure()
        run: |
          cd /tmp/mythic
          sudo ./mythic-cli logs > mythic-logs.txt 2>&1 || true
          sudo docker ps -a > docker-containers.txt || true

      - name: Upload Mythic Logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mythic-failure-logs
          path: |
            /tmp/mythic/mythic-logs.txt
            /tmp/mythic/docker-containers.txt
          retention-days: 7

      - name: Cleanup Mythic
        if: always()
        run: |
          cd /tmp/mythic
          sudo ./mythic-cli stop || true
          sudo docker system prune -af || true
